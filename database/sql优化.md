# SQL 优化方案
## mysql优化

### 1. mysql执行逻辑

![Lapland](https://raw.githubusercontent.com/ww-1009/interview/main/img/database/mysql_execute.png "Lapland")

1. **连接器**： 主要负责跟客户端建立连接、获取权限、维持和管理连接
   
2. **查询缓存**： 优先在缓存中进行查询，如果查到了则直接返回，如果缓存中查询不到，在去数据库中查询。
   
    MySQL缓存是默认关闭的，也就是说不推荐使用缓存，并且在MySQL8.0 版本已经将查询缓存的整块功能删掉了。这主要是它的使用场景限制造成的：

   * 先说下缓存中数据存储格式：key（sql语句）- value（数据值），所以如果SQL语句（key）只要存在一点不同之处就会直接进行数据库查询了；
   * 由于表中的数据不是一成不变的，大多数是经常变化的，而当数据库中的数据变化了，那么相应的与此表相关的缓存数据就需要移除掉；

3. **解析器/分析器**： 分析器的工作主要是对要执行的SQL语句进行词法解析、语法解析，最终得到抽象语法树，然后再使用预处理器对抽象语法树进行语义校验，判断抽象语法树中的表是否存在，如果存在的话，在接着判断select投影列字段是否在表中存在等。

4. **优化器**： 主要将SQL经过词法解析、语法解析后得到的语法树，通过数据字典和统计信息的内容，再经过一系列运算 ，最终得出一个执行计划，包括选择使用哪个索引
   
   * 在分析是否走索引查询时，是通过进行动态数据采样统计分析出来；只要是统计分析出来的，那就可能会存在分析错误的情况，所以在SQL执行不走索引时，也要考虑到这方面的因素

5. **执行器**： 根据一系列的执行计划去调用存储引擎提供的API接口去调用操作数据，完成SQL的执行。

### 2. SQL语句及索引的优化

1. **尽量避免使用子查询**
2. **用IN来替换OR**
3. **读取适当的记录LIMIT M,N，而不要读多余的记录**
4. **禁止不必要的Order By排序**
5. **总和查询可以禁止排重用union all**
6. **避免随机取记录**
7. **将多次插入换成批量Insert插入**
8. **只返回必要的列，用具体的字段列表代替 select * 语句**
9. **区分in和exists**
10. **优化Group By语句**
11. **尽量使用数字型字段**
12. **优化Join语句**